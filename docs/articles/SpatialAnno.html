<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SpatialAnno • SpatialAnno</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="SpatialAnno">
<meta property="og:description" content="SpatialAnno">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SpatialAnno</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/SpatialAnno.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MOB.html">SpatialAnno for MOB</a>
    </li>
    <li>
      <a href="../articles/brain.html">SpatialAnno for Human_Brain</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="SpatialAnno_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>SpatialAnno</h1>
            
      
      
      <div class="hidden name"><code>SpatialAnno.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="install-the-spatialanno">Install the SpatialAnno<a class="anchor" aria-label="anchor" href="#install-the-spatialanno"></a>
</h2>
<p>This vignette provides an introduction to the R package <code>SpatialAnno</code>, where the function <code>SpatialAnno</code> implements the model <code>SpatialAnno</code>, an efficient and accurate annotation method for spatial transcriptomics datasets, with the capability of effectively leveraging a large number of non-marker genes with “qualitative” information about marker genes, without using a reference dataset. The package can be installed with the command:</p>
<p><code><a href="https://devtools.r-lib.org/" class="external-link">library(devtools)</a></code></p>
<p><code>install_github("Shufeyangyi2015310117/SpatialAnno")</code></p>
<p>The package can be loaded with the command:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"SpatialAnno"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="spatialanno-for-simulated-data">SpatialAnno for simulated data<a class="anchor" aria-label="anchor" href="#spatialanno-for-simulated-data"></a>
</h2>
<div class="section level3">
<h3 id="generating-the-simulated-data">Generating the simulated data<a class="anchor" aria-label="anchor" href="#generating-the-simulated-data"></a>
</h3>
<p>We first set the basic parameter. The spatial locations of 3639 spots were taken from DLPFC section 151673. Cell types are assigned with the manually annotations from the original studies. It contains 7 cell types and some “Unknown”. The number of markers for each cell type is set to 4.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://mvtnorm.R-forge.R-project.org" class="external-link">mvtnorm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SingleCellExperiment</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Oshlack/splatter" class="external-link">splatter</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dlpfc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span>file <span class="op">=</span>   <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/find.package.html" class="external-link">path.package</a></span><span class="op">(</span><span class="st">"SpatialAnno"</span><span class="op">)</span>,<span class="st">"/extdata/151673.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pos</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">dlpfc</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"row"</span>, <span class="st">"col"</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">dlpfc</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="co"># number of spots</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">200</span> <span class="co">## number of non-markers</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">dlpfc</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"layer_guess_reordered"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">8</span></span>
<span><span class="va">y2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"ct"</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="va">y2</span><span class="op">[</span><span class="va">y2</span><span class="op">==</span><span class="st">"ct8"</span><span class="op">]</span> <span class="op">=</span> <span class="st">"Unknown"</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span><span class="fl">1</span> <span class="co">## number of clusters</span></span>
<span><span class="va">num_mk_per_ct</span> <span class="op">=</span> <span class="fl">5</span> <span class="co">## number of markers per cell type</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="va">num_mk_per_ct</span>  <span class="op">*</span> <span class="va">K</span> <span class="co">## number of markers</span></span></code></pre></div>
<p>Then we define the function that can generate raw count. We simulated gene expression for each spot using the splatter package. The parameter for the proportion of DEGs (de.prob) in each layer was set as 0.5. The DE strength is determined by both mean parameter de.facloc and scale parameter de.facScale, the former ranges from 0.1 to 0.8 and the latter was set within [0.1,1], corresponding to the log fold change in expression from one-fold to two-fold across different types. All the other parameters are set based on their estimates in the seven layers from DLPFC section 151673.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generate_count</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">J</span> <span class="op">=</span> <span class="fl">100</span>, <span class="va">de_facLoc</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">de_facScale</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">dlpfc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span>file <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/find.package.html" class="external-link">path.package</a></span><span class="op">(</span><span class="st">"SpatialAnno"</span><span class="op">)</span>,<span class="st">"/extdata/151673.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">dlpfc</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="co"># number of spots</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">2000</span> <span class="co">## number of non-markers</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">dlpfc</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"layer_guess_reordered"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">8</span></span>
<span></span>
<span>  <span class="va">dec</span> <span class="op">&lt;-</span> <span class="fu">scran</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scran/man/modelGeneVar.html" class="external-link">modelGeneVar</a></span><span class="op">(</span><span class="va">dlpfc</span><span class="op">)</span></span>
<span>  <span class="va">top</span> <span class="op">&lt;-</span> <span class="fu">scran</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scran/man/getTopHVGs.html" class="external-link">getTopHVGs</a></span><span class="op">(</span><span class="va">dec</span>, n <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span>  <span class="va">cnts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/dge.html" class="external-link">counts</a></span><span class="op">(</span><span class="va">dlpfc</span><span class="op">)</span><span class="op">[</span><span class="va">top</span>,<span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">init_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/splatter/man/splatEstimate.html" class="external-link">splatEstimate</a></span><span class="op">(</span><span class="va">cnts</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">num_mk_per_ct</span> <span class="op">=</span> <span class="fl">5</span></span>
<span>  <span class="va">batch_facLoc</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="va">C</span> <span class="op">=</span> <span class="fl">8</span></span>
<span>  <span class="va">I</span> <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="va">N</span> <span class="op">=</span> <span class="fl">7000</span></span>
<span>  <span class="va">L</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="va">de_prop</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">8</span><span class="op">)</span></span>
<span>  <span class="va">debug</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  </span>
<span>  <span class="co"># 1.simulate count data</span></span>
<span>  <span class="va">noBatch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">batch_facLoc</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">group_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/splatter/man/setParams.html" class="external-link">setParams</a></span><span class="op">(</span></span>
<span>    <span class="va">init_params</span>, </span>
<span>    batchCells <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">N</span>, <span class="va">L</span><span class="op">)</span>, <span class="co"># 3N here represents a large number such that</span></span>
<span>    <span class="co"># we have sufficient cells of each type to be </span></span>
<span>    <span class="co"># allocated to the spatial transcriptomics data</span></span>
<span>    batch.rmEffect <span class="op">=</span> <span class="va">noBatch</span>,</span>
<span>    batch.facLoc <span class="op">=</span> <span class="va">batch_facLoc</span>,</span>
<span>    nGenes <span class="op">=</span> <span class="va">J</span>,</span>
<span>    group.prob <span class="op">=</span> <span class="va">group_prob</span>,</span>
<span>    out.prob <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    de.prob <span class="op">=</span> <span class="va">de_prop</span>,</span>
<span>    de.facLoc <span class="op">=</span> <span class="va">de_facLoc</span>,</span>
<span>    de.facScale <span class="op">=</span> <span class="va">de_facScale</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">sim_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/splatter/man/splatSimulate.html" class="external-link">splatSimulate</a></span><span class="op">(</span></span>
<span>    params <span class="op">=</span> <span class="va">params</span>, </span>
<span>    method <span class="op">=</span> <span class="st">"groups"</span>, </span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">scuttle</span><span class="op">)</span></span>
<span>  <span class="va">sim_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scuttle/man/logNormCounts.html" class="external-link">logNormCounts</a></span><span class="op">(</span><span class="va">sim_groups</span><span class="op">)</span></span>
<span>  <span class="va">seu</span> <span class="op">=</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/as.Seurat.html" class="external-link">as.Seurat</a></span><span class="op">(</span><span class="va">sim_groups</span><span class="op">)</span></span>
<span>  <span class="va">seu</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Seurat/man/SCTransform.html" class="external-link">SCTransform</a></span><span class="op">(</span><span class="va">seu</span>, assay <span class="op">=</span> <span class="st">"originalexp"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/Idents.html" class="external-link">Idents</a></span><span class="op">(</span><span class="va">seu</span><span class="op">)</span> <span class="op">=</span> <span class="va">seu</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">Group</span></span>
<span>  <span class="va">all.markers</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Seurat/man/FindAllMarkers.html" class="external-link">FindAllMarkers</a></span><span class="op">(</span><span class="va">seu</span>, assay <span class="op">=</span> <span class="st">"SCT"</span>, logfc.threshold <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span>  <span class="va">all.markers</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/top_n.html" class="external-link">top_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">num_mk_per_ct</span>, wt <span class="op">=</span> <span class="va">avg_log2FC</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">top5</span></span>
<span>  </span>
<span>  <span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>top5 <span class="op">=</span> <span class="va">top5</span>, sim_groups <span class="op">=</span> <span class="va">sim_groups</span>, all.markers <span class="op">=</span> <span class="va">all.markers</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="generate-raw-count-and-marker-gene-matrix">generate raw count and marker gene matrix<a class="anchor" aria-label="anchor" href="#generate-raw-count-and-marker-gene-matrix"></a>
</h3>
<p>Five marker genes for each cell type were selected from the top DEGs based on log-fold change.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res1</span> <span class="op">=</span> <span class="fu">generate_count</span><span class="op">(</span>J <span class="op">=</span> <span class="fl">100</span>, de_facLoc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span>,<span class="fl">6</span>,<span class="fl">7</span>,<span class="fl">8</span><span class="op">)</span><span class="op">*</span><span class="fl">0.1</span>, de_facScale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">1</span>,<span class="fl">0.1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0.10</span>,<span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">res2</span> <span class="op">=</span> <span class="fu">generate_count</span><span class="op">(</span>J <span class="op">=</span> <span class="va">p</span>, de_facLoc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span>,<span class="fl">6</span>,<span class="fl">7</span>,<span class="fl">8</span><span class="op">)</span><span class="op">*</span><span class="fl">0.1</span>, de_facScale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">1</span>,<span class="fl">0.1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0.10</span>,<span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res1</span><span class="op">$</span><span class="va">all.markers</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/top_n.html" class="external-link">top_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">15</span>, wt <span class="op">=</span> <span class="va">avg_log2FC</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">top15</span></span>
<span><span class="va">adjusted_top5_gene</span> <span class="op">=</span> <span class="va">top15</span><span class="op">$</span><span class="va">gene</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">16</span><span class="op">:</span><span class="fl">20</span>,<span class="fl">31</span><span class="op">:</span><span class="fl">35</span>,<span class="fl">46</span><span class="op">:</span><span class="fl">50</span>,<span class="fl">61</span><span class="op">:</span><span class="fl">65</span>,<span class="fl">76</span><span class="op">:</span><span class="fl">80</span>,<span class="fl">91</span><span class="op">:</span><span class="fl">95</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">##################################1:5,16:20,31:35,46:50,61:65,76:80,91:95</span></span>
<span><span class="co">### c(11:15,26:30,31:35,56:60,61:65,86:90,101:105)</span></span>
<span></span>
<span><span class="co">## reorder the sample to be matched with y</span></span>
<span><span class="va">Groupy</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Group"</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="va">num_each_celltype</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="va">idx1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">idx1</span><span class="op">[</span><span class="va">y</span><span class="op">==</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">res1</span><span class="op">$</span><span class="va">sim_groups</span><span class="op">)</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Group"</span>,<span class="va">i</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">num_each_celltype</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">idx2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">idx2</span><span class="op">[</span><span class="va">y</span><span class="op">==</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">res2</span><span class="op">$</span><span class="va">sim_groups</span><span class="op">)</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Group"</span>,<span class="va">i</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">num_each_celltype</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> </span>
<span><span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span><span class="co">## ordered samples</span></span>
<span><span class="va">X1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/dge.html" class="external-link">counts</a></span><span class="op">(</span><span class="va">res1</span><span class="op">$</span><span class="va">sim_groups</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">adjusted_top5_gene</span><span class="op">)</span>,<span class="va">idx1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X1</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"Gene"</span>,<span class="st">"mk"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">X2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/dge.html" class="external-link">counts</a></span><span class="op">(</span><span class="va">res2</span><span class="op">$</span><span class="va">sim_groups</span><span class="op">)</span><span class="op">[</span>,<span class="va">idx2</span><span class="op">]</span></span>
<span><span class="va">colsum</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X2</span>,<span class="fl">1</span>,<span class="va">sum</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">colsum</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">idx_not_equal_zero</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">colsum</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">X2</span> <span class="op">=</span> <span class="va">X2</span><span class="op">[</span><span class="va">idx_not_equal_zero</span>,<span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span>  </span>
<span><span class="co">## generate rho</span></span>
<span><span class="va">rho</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">X1</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">K</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">rho</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"Gene"</span>,<span class="st">"mk"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rho</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">K</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"ct"</span>, <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">K</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rho</span><span class="op">)</span><span class="op">[</span><span class="va">K</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Unknown"</span></span>
<span><span class="va">res1_top5_gene</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"Gene"</span>,<span class="st">"mk"</span>, <span class="va">adjusted_top5_gene</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">K</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">rho</span><span class="op">[</span><span class="va">res1_top5_gene</span><span class="op">[</span><span class="op">(</span><span class="op">(</span><span class="va">k</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">num_mk_per_ct</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">k</span><span class="op">*</span><span class="va">num_mk_per_ct</span><span class="op">)</span><span class="op">]</span>, <span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## define markers</span></span>
<span><span class="va">marker</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">K</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">marker</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">rho</span><span class="op">)</span><span class="op">[</span><span class="va">rho</span><span class="op">[</span>,<span class="va">k</span><span class="op">]</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">marker</span><span class="op">)</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rho</span><span class="op">)</span><span class="op">[</span><span class="va">k</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then we construct the sce object and perform the normalization on simulated data using function <code>logNormCounts</code> implemented in the R packages <code>scran</code></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># -------------------------------------------------</span></span>
<span><span class="co"># make BayesSpace metadata used in BayesSpace</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">X1</span>, <span class="va">X2</span><span class="op">)</span></span>
<span><span class="co">## Make array coordinates - filled rectangle</span></span>
<span><span class="va">cdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cdata</span><span class="op">$</span><span class="va">row</span> <span class="op">&lt;-</span> <span class="va">pos</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">cdata</span><span class="op">$</span><span class="va">col</span> <span class="op">&lt;-</span> <span class="va">pos</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">cdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">cdata</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cdata</span><span class="op">$</span><span class="va">imagerow</span> <span class="op">&lt;-</span> <span class="va">cdata</span><span class="op">$</span><span class="va">row</span></span>
<span><span class="va">cdata</span><span class="op">$</span><span class="va">imagecol</span> <span class="op">&lt;-</span> <span class="va">cdata</span><span class="op">$</span><span class="va">col</span> </span>
<span><span class="co">## Make SCE</span></span>
<span><span class="co">## note: scater::runPCA throws warning on our small sim data, so use prcomp</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/SingleCellExperiment.html" class="external-link">SingleCellExperiment</a></span><span class="op">(</span>assays<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>counts<span class="op">=</span><span class="va">counts</span><span class="op">)</span>, colData<span class="op">=</span><span class="va">cdata</span><span class="op">)</span></span>
<span><span class="va">sce</span><span class="op">$</span><span class="va">spatial.cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">metadata</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">BayesSpace.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">metadata</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">BayesSpace.data</span><span class="op">$</span><span class="va">platform</span> <span class="op">&lt;-</span> <span class="st">"Visium"</span></span>
<span><span class="fu">metadata</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">BayesSpace.data</span><span class="op">$</span><span class="va">is.enhanced</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scuttle/man/logNormCounts.html" class="external-link">logNormCounts</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html" class="external-link">logcounts</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="run-spatialanno-on-simulated-datasets">Run SpatialAnno on simulated datasets<a class="anchor" aria-label="anchor" href="#run-spatialanno-on-simulated-datasets"></a>
</h3>
<p>Then we find the neighborhoods using the function <code>find_neighbors2</code> implemented in our package <code>SpatialAnno</code>, with specifying the type of platform as <code>Visium</code>, as DLPFC 151673 was sequenced on the platform 10x Genomics Visium. After obtaining the sparse neighborhoods matrix <code>Adj_sp</code>, we can run SpatialAnno with normalized gene expression matrix <code>X</code>, sparse neighborhoods matrix <code>Adj_sp</code>, and a list of markers <code>marker</code>. Note that we choose the initial value from annotation methods <code>scSorter</code> due to low-dimensional non-markers.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Adj_sp</span> <span class="op">=</span> <span class="fu"><a href="../reference/find_neighbors2.html">find_neighbors2</a></span><span class="op">(</span><span class="va">sce</span>, platform <span class="op">=</span> <span class="st">"Visium"</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SpatialAnno.html">SpatialAnno</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, Adj_sp <span class="op">=</span> <span class="va">Adj_sp</span>, marker <span class="op">=</span> <span class="va">marker</span>, initial <span class="op">=</span> <span class="st">"scSorter"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "mk22" "mk23" "mk38" "mk40" "mk44"</span></span>
<span><span class="co">## [1] "mk11" "mk23" "mk38" "mk40" "mk41"</span></span>
<span><span class="co">## [1] "mk14" "mk48" "mk56" "mk58" "mk88"</span></span>
<span><span class="co">## [1] "mk19" "mk54" "mk55" "mk73" "mk92"</span></span>
<span><span class="co">## [1] "mk10" "mk49" "mk61" "mk69" "mk87"</span></span>
<span><span class="co">## [1] "mk20" "mk33" "mk34" "mk46" "mk63"</span></span>
<span><span class="co">## [1] "mk1"  "mk38" "mk5"  "mk73" "mk93"</span></span>
<span><span class="co">## iter = 2, loglik= -1467207.486145, dloglik=0.999317 </span></span>
<span><span class="co">## iter = 3, loglik= -1160303.555200, dloglik=0.209176 </span></span>
<span><span class="co">## iter = 4, loglik= -1159056.221116, dloglik=0.001075 </span></span>
<span><span class="co">## iter = 5, loglik= -1158311.122888, dloglik=0.000643 </span></span>
<span><span class="co">## iter = 6, loglik= -1157758.472042, dloglik=0.000477 </span></span>
<span><span class="co">## iter = 7, loglik= -1157421.496115, dloglik=0.000291 </span></span>
<span><span class="co">## iter = 8, loglik= -1157232.511740, dloglik=0.000163 </span></span>
<span><span class="co">## iter = 9, loglik= -1157118.927866, dloglik=0.000098 </span></span>
<span><span class="co">## iter = 10, loglik= -1157042.299173, dloglik=0.000066 </span></span>
<span><span class="co">## iter = 11, loglik= -1156985.611640, dloglik=0.000049 </span></span>
<span><span class="co">## iter = 12, loglik= -1156941.352391, dloglik=0.000038 </span></span>
<span><span class="co">## iter = 13, loglik= -1156905.571381, dloglik=0.000031 </span></span>
<span><span class="co">## iter = 14, loglik= -1156875.913760, dloglik=0.000026 </span></span>
<span><span class="co">## iter = 15, loglik= -1156849.423535, dloglik=0.000023 </span></span>
<span><span class="co">## iter = 16, loglik= -1156828.276321, dloglik=0.000018 </span></span>
<span><span class="co">## iter = 17, loglik= -1156810.074081, dloglik=0.000016 </span></span>
<span><span class="co">## iter = 18, loglik= -1156794.243516, dloglik=0.000014 </span></span>
<span><span class="co">## iter = 19, loglik= -1156780.356645, dloglik=0.000012 </span></span>
<span><span class="co">## iter = 20, loglik= -1156768.083772, dloglik=0.000011 </span></span>
<span><span class="co">## iter = 21, loglik= -1156757.166083, dloglik=0.000009 </span></span>
<span><span class="co">## iter = 22, loglik= -1156747.397225, dloglik=0.000008 </span></span>
<span><span class="co">## iter = 23, loglik= -1156738.610441, dloglik=0.000008 </span></span>
<span><span class="co">## iter = 24, loglik= -1156730.669374, dloglik=0.000007 </span></span>
<span><span class="co">## iter = 25, loglik= -1156723.461371, dloglik=0.000006 </span></span>
<span><span class="co">## iter = 26, loglik= -1156716.892517, dloglik=0.000006 </span></span>
<span><span class="co">## iter = 27, loglik= -1156710.883883, dloglik=0.000005 </span></span>
<span><span class="co">## iter = 28, loglik= -1156705.368664, dloglik=0.000005 </span></span>
<span><span class="co">## iter = 29, loglik= -1156700.289947, dloglik=0.000004 </span></span>
<span><span class="co">## iter = 30, loglik= -1156695.598959, dloglik=0.000004 </span></span>
<span><span class="co">## iter = 31, loglik= -1156691.253683, dloglik=0.000004 </span></span>
<span><span class="co">## iter = 32, loglik= -1156687.217739, dloglik=0.000003 </span></span>
<span><span class="co">## iter = 33, loglik= -1156683.459482, dloglik=0.000003 </span></span>
<span><span class="co">## iter = 34, loglik= -1156679.951272, dloglik=0.000003 </span></span>
<span><span class="co">## iter = 35, loglik= -1156676.668865, dloglik=0.000003 </span></span>
<span><span class="co">## iter = 36, loglik= -1156673.590924, dloglik=0.000003 </span></span>
<span><span class="co">## iter = 37, loglik= -1156670.698595, dloglik=0.000003 </span></span>
<span><span class="co">## iter = 38, loglik= -1156667.975172, dloglik=0.000002 </span></span>
<span><span class="co">## iter = 39, loglik= -1156665.405799, dloglik=0.000002 </span></span>
<span><span class="co">## iter = 40, loglik= -1156662.977230, dloglik=0.000002 </span></span>
<span><span class="co">## iter = 41, loglik= -1156660.677619, dloglik=0.000002 </span></span>
<span><span class="co">## iter = 42, loglik= -1156658.209368, dloglik=0.000002 </span></span>
<span><span class="co">## iter = 43, loglik= -1156656.140278, dloglik=0.000002 </span></span>
<span><span class="co">## iter = 44, loglik= -1156654.172656, dloglik=0.000002 </span></span>
<span><span class="co">## iter = 45, loglik= -1156652.297414, dloglik=0.000002 </span></span>
<span><span class="co">## iter = 46, loglik= -1156650.507371, dloglik=0.000002 </span></span>
<span><span class="co">## iter = 47, loglik= -1156648.796098, dloglik=0.000001 </span></span>
<span><span class="co">## iter = 48, loglik= -1156647.157781, dloglik=0.000001 </span></span>
<span><span class="co">## iter = 49, loglik= -1156645.587138, dloglik=0.000001 </span></span>
<span><span class="co">## iter = 50, loglik= -1156644.079361, dloglik=0.000001 </span></span>
<span><span class="co">## iter = 51, loglik= -1156642.630064, dloglik=0.000001 </span></span>
<span><span class="co">## iter = 52, loglik= -1156641.235236, dloglik=0.000001 </span></span>
<span><span class="co">## iter = 53, loglik= -1156639.891206, dloglik=0.000001 </span></span>
<span><span class="co">## iter = 54, loglik= -1156638.594606, dloglik=0.000001 </span></span>
<span><span class="co">## iter = 55, loglik= -1156637.342342, dloglik=0.000001 </span></span>
<span><span class="co">## iter = 56, loglik= -1156636.131571, dloglik=0.000001 </span></span>
<span><span class="co">## iter = 57, loglik= -1156634.959674, dloglik=0.000001 </span></span>
<span><span class="co">## iter = 58, loglik= -1156633.824237, dloglik=0.000001</span></span></code></pre>
<p>We demonstrate the output of SpatialAnno, which is a list contains many items. We will explain them one by one in the following part.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 13</span></span>
<span><span class="co">##  $ R      : num [1:3639, 1:8] 3.46e-52 1.00 3.74e-23 1.42e-48 1.15e-65 ...</span></span>
<span><span class="co">##  $ xi     : num 2.5</span></span>
<span><span class="co">##  $ type   : int [1:3639, 1] 3 1 7 3 5 6 7 3 1 6 ...</span></span>
<span><span class="co">##  $ alpha_m: num [1:30, 1] 1.83 2.87 2.34 3.33 2.98 ...</span></span>
<span><span class="co">##  $ bet_m  : num [1:30, 1:8] 1.4 1.16 2.58 1.5 1.13 ...</span></span>
<span><span class="co">##  $ mu_m   : num [1:30, 1:8] 3.23 4.02 4.92 4.83 4.1 ...</span></span>
<span><span class="co">##  $ sigma_m: num [1:30, 1] 1.88 1.76 1.76 1.57 1.74 ...</span></span>
<span><span class="co">##  $ Ez_u   : num [1:3639, 1:15] 8.2 10.11 13.38 8.06 7.23 ...</span></span>
<span><span class="co">##  $ Mu_u   : num [1:8, 1:15] 9.59 5.01 8.23 10.59 7.53 ...</span></span>
<span><span class="co">##  $ Sgm_u  : num [1:15, 1:15] 4.017 0.445 2.513 0.983 -3.627 ...</span></span>
<span><span class="co">##  $ W_u    : num [1:200, 1:15] 0.0785 -0.0292 0.0496 0.0211 0.0439 ...</span></span>
<span><span class="co">##  $ Lam_u  : num [1:200, 1] 0.738 0.833 0.709 0.617 0.971 ...</span></span>
<span><span class="co">##  $ loglik : num [1:57] -2.15e+09 -1.47e+06 -1.16e+06 -1.16e+06 -1.16e+06 ...</span></span></code></pre>
<ul>
<li>‘R’ the estimator of probability that each spot was assigned to these five cell types or “Unknown”. The order of the cell types is the same as that of cell types in gene marker matrix.</li>
<li>‘xi’ the estimator of smooth parameter.</li>
<li>‘type’ the predicated cell types for each spot.</li>
<li>‘alpha_m’ the estimator of base expression level.</li>
<li>‘bet_m’ the estimator of extra expression level.</li>
<li>‘mu_m’ the mean of cell types in marker group.</li>
<li>‘sigma_m’ the covariance matrix of cell types in marker group.</li>
<li>‘Ez_u’ the low-dimensional embedding.</li>
<li>‘Mu_u’ the mean of cell types in non-marker group.</li>
<li>‘Sgm_u’ the covariance matrix of cell types in non-marker group.</li>
<li>‘W_u’ the estimator of factor loading matrix.</li>
<li>‘Lam_u’ the variance of error in non-marker group.</li>
<li>‘loglik’ the vector of log-likelihood of <code>SpatialAnno</code>.</li>
</ul>
</div>
<div class="section level3">
<h3 id="plot-the-annotation-results">plot the annotation results<a class="anchor" aria-label="anchor" href="#plot-the-annotation-results"></a>
</h3>
<p>The predictions can be obtained in the following way. Then we can plot the annotation results of SpatialAnno on the original positions using R package <code>ggplot2</code></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prediction</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rho</span><span class="op">)</span><span class="op">[</span><span class="va">fit</span><span class="op">$</span><span class="va">type</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "ct3" "ct1" "ct7" "ct3" "ct5" "ct6" "ct7" "ct3" "ct1" "ct6" "ct7" "ct4"</span></span>
<span><span class="co">## [13] "ct5" "ct3" "ct5" "ct3" "ct6" "ct5" "ct1" "ct6"</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">fit_type</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rho</span><span class="op">)</span><span class="op">[</span><span class="va">fit</span><span class="op">$</span><span class="va">type</span><span class="op">]</span></span>
<span><span class="va">pos</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="va">pos</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">dat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">pos</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">pos</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">fit_type</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"imagerow"</span>, <span class="st">"imagecol"</span>, <span class="st">"Cell type"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">imagerow</span>, y<span class="op">=</span><span class="va">imagecol</span>, color<span class="op">=</span><span class="va">`Cell type`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.ticks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p1</span></span></code></pre></div>
<p><img src="SpatialAnno_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="calculate-kappa-mf1-and-acc">calculate Kappa, mF1, and acc<a class="anchor" aria-label="anchor" href="#calculate-kappa-mf1-and-acc"></a>
</h3>
<p>After obtaining the predictions, we can calculate Kappa, mF1 (mean F1), and acc to evalute the performance of annotation results by <code>SpatialAnno</code>. The function <code>cohen.kappa</code> to calculate Kappa is implemented in the package psych. The function <code>evaluate</code> to calculate mF1 is implemented in our package <code>SpatialAnno</code>. The Kappa is</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://personality-project.org/r/psych/" class="external-link">psych</a></span><span class="op">)</span></span>
<span><span class="va">idx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">y2</span><span class="op">!=</span><span class="st">"Unknown"</span> <span class="op">&amp;</span> <span class="va">prediction</span><span class="op">!=</span><span class="st">"Unknown"</span><span class="op">)</span></span>
<span><span class="va">Kappa</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/psych/man/kappa.html" class="external-link">cohen.kappa</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">y2</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>, <span class="va">prediction</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">kappa</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">Kappa</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.9140835</span></span></code></pre>
<p>The mF1 is</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mF1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="../reference/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">y2</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>, <span class="va">prediction</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">F1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">mF1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.8183227</span></span></code></pre>
<p>The acc is</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">acc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y2</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span> <span class="op">==</span> <span class="va">prediction</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">acc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.9296594</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="extract-the-embeddings">extract the embeddings<a class="anchor" aria-label="anchor" href="#extract-the-embeddings"></a>
</h3>
<p>Then we extract the embeddings from the output of <code>SpatialAnno</code>, and plot the tSNE and calculate ARI with the function <code>adjustedRandIndex</code> implemented in the R package <code>mclust</code></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://bioconductor.org/packages/scater/" class="external-link">scater</a></span><span class="op">)</span></span>
<span><span class="va">embedding</span> <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">Ez_u</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           [,1]     [,2]      [,3]     [,4]      [,5]       [,6]      [,7]</span></span>
<span><span class="co">## [1,]  8.200934 4.476067 11.438057 4.497795 -14.71717  2.2841504  4.460064</span></span>
<span><span class="co">## [2,] 10.114228 2.842798 13.357539 4.504574 -14.94004  2.7476946 10.643506</span></span>
<span><span class="co">## [3,] 13.383633 2.318947 10.986487 4.481825 -15.31096  1.8013694  7.769313</span></span>
<span><span class="co">## [4,]  8.064062 3.235666 10.708896 4.696581 -12.87674  3.0176053  4.083591</span></span>
<span><span class="co">## [5,]  7.234133 1.561023  9.402078 4.409085 -14.87095  7.3525165  9.731576</span></span>
<span><span class="co">## [6,]  6.485527 2.379345 13.300804 5.590139 -12.80716 -0.9256822  4.942769</span></span>
<span><span class="co">##           [,8]       [,9]      [,10]      [,11]     [,12]      [,13]     [,14]</span></span>
<span><span class="co">## [1,] -18.60973 -0.4446807 -1.3097434  1.0922510  5.741625 -16.821980 -9.101355</span></span>
<span><span class="co">## [2,] -25.92402 -0.7540642 -0.3209393  2.2472831  2.485593  -8.610126 -4.234882</span></span>
<span><span class="co">## [3,] -29.58129 -7.8842991  0.6316807 -0.8186432  3.486277  -9.289701 -6.595325</span></span>
<span><span class="co">## [4,] -16.73786 -0.5455508 -1.0143665  0.3906326  2.974831 -17.350978 -6.723654</span></span>
<span><span class="co">## [5,] -21.72303  1.6026990 -7.1421597 -7.9475153  3.997371  -4.172060 -4.402423</span></span>
<span><span class="co">## [6,] -19.11774 -5.3660077 -8.2743829  5.6032033 -2.765648  -3.087866 -5.903869</span></span>
<span><span class="co">##           [,15]</span></span>
<span><span class="co">## [1,] -4.5227073</span></span>
<span><span class="co">## [2,] -3.9502406</span></span>
<span><span class="co">## [3,] -3.4842198</span></span>
<span><span class="co">## [4,] -2.7758946</span></span>
<span><span class="co">## [5,] -0.8484403</span></span>
<span><span class="co">## [6,] -2.0439957</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tsne</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/runTSNE.html" class="external-link">calculateTSNE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The tSNE plot is</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">tsne</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">cluster</span> <span class="op">=</span> <span class="va">prediction</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X</span>, y<span class="op">=</span><span class="va">Y</span>, color<span class="op">=</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.ticks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p1</span></span></code></pre></div>
<p><img src="SpatialAnno_files/figure-html/unnamed-chunk-13-1.png" width="384"></p>
<p>Then we perform the clustering analysis with GMM on embedding and calculate ARI. The ARI is</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit2</span> <span class="op">=</span> <span class="fu"><a href="https://mclust-org.github.io/mclust/reference/Mclust.html" class="external-link">Mclust</a></span><span class="op">(</span><span class="va">embedding</span>, G <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">ARI</span> <span class="op">=</span> <span class="fu"><a href="https://mclust-org.github.io/mclust/reference/adjustedRandIndex.html" class="external-link">adjustedRandIndex</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">fit2</span><span class="op">$</span><span class="va">classification</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ARI</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.6971748</span></span></code></pre>
<p>We can also plot RGB plot with the function <code>plot_RGB</code> implemented in <code>PRECAST</code>. The RGB plot is demonstrated as follows</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/feiyoung/PRECAST" class="external-link">PRECAST</a></span><span class="op">)</span></span>
<span><span class="va">tsne3dim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/runTSNE.html" class="external-link">calculateTSNE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span>, ncomponents <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">pList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PRECAST/man/plot_RGB.html" class="external-link">plot_RGB</a></span><span class="op">(</span><span class="va">pos</span>, <span class="va">tsne3dim</span>, pointsize <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">pList</span></span></code></pre></div>
<p><img src="SpatialAnno_files/figure-html/unnamed-chunk-15-1.png" width="288"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Yi Yang, Xingjie Shi.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
