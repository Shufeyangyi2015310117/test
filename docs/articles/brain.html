<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SpatialAnno for Human_Brain • SpatialAnno</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="SpatialAnno for Human_Brain">
<meta property="og:description" content="SpatialAnno">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SpatialAnno</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/SpatialAnno.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MOB.html">SpatialAnno for MOB</a>
    </li>
    <li>
      <a href="../articles/brain.html">SpatialAnno for Human_Brain</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="brain_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>SpatialAnno for Human_Brain</h1>
            
            <h4 data-toc-skip class="date">2022-11-27</h4>
      
      
      <div class="hidden name"><code>brain.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="human-brain-data">Human Brain data<a class="anchor" aria-label="anchor" href="#human-brain-data"></a>
</h2>
<p>We obtained the human brain slices data from the spatialLIBD project. This data consists of gene expression levels in form of read counts which are collected for a number of spatial locations. We followed to focus on the 9th slices of the human brain section 12, which contains 2000 genes and 3639 spatial locations. The gene expression of the 9th slices human brain section 12 and ground truth are both stored in the R package <code>SpatialAnno</code>.</p>
<div class="section level3">
<h3 id="load-the-brain-datasets">load the brain datasets<a class="anchor" aria-label="anchor" href="#load-the-brain-datasets"></a>
</h3>
<p>First, we load the brain datasets and extract the position of each spot from spot name.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">99</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SpatialAnno</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span>file <span class="op">=</span>   <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/find.package.html" class="external-link">path.package</a></span><span class="op">(</span><span class="st">"SpatialAnno"</span><span class="op">)</span>,<span class="st">"/extdata/brain.RData"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                    ENSG00000187608 ENSG00000179403 ENSG00000187730</span></span>
<span><span class="co">## AAACAAGTATCTCCCA-1       0.0000000       0.4655466       1.0993096</span></span>
<span><span class="co">## AAACAATCTACTAGCA-1       0.0000000       0.0000000       1.5349570</span></span>
<span><span class="co">## AAACACCAATAACTGC-1       0.0000000       0.0000000       0.9662463</span></span>
<span><span class="co">## AAACAGAGCGACTCCT-1       0.0000000       0.0000000       0.7453531</span></span>
<span><span class="co">## AAACAGCTTTCAGAAG-1       0.8048847       0.0000000       0.0000000</span></span>
<span><span class="co">## AAACAGGGTCTATATT-1       0.0000000       0.0000000       0.8860993</span></span>
<span><span class="co">##                    ENSG00000069424 ENSG00000116251 ENSG00000097021</span></span>
<span><span class="co">## AAACAAGTATCTCCCA-1        1.099310        1.538142        1.335347</span></span>
<span><span class="co">## AAACAATCTACTAGCA-1        1.534957        0.000000        0.000000</span></span>
<span><span class="co">## AAACACCAATAACTGC-1        0.000000        1.539780        0.000000</span></span>
<span><span class="co">## AAACAGAGCGACTCCT-1        1.889683        1.598915        0.000000</span></span>
<span><span class="co">## AAACAGCTTTCAGAAG-1        0.000000        1.696447        0.000000</span></span>
<span><span class="co">## AAACAGGGTCTATATT-1        0.000000        1.825589        0.000000</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dlpfc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## class: SingleCellExperiment </span></span>
<span><span class="co">## dim: 6 3639 </span></span>
<span><span class="co">## metadata(2): image BayesSpace.data</span></span>
<span><span class="co">## assays(2): counts logcounts</span></span>
<span><span class="co">## rownames(6): ENSG00000243485 ENSG00000237613 ... ENSG00000239945</span></span>
<span><span class="co">##   ENSG00000239906</span></span>
<span><span class="co">## rowData names(9): source type ... gene_search is_top_hvg</span></span>
<span><span class="co">## colnames(3639): AAACAAGTATCTCCCA-1 AAACAATCTACTAGCA-1 ...</span></span>
<span><span class="co">##   TTGTTTGTATTACACG-1 TTGTTTGTGTAAATTC-1</span></span>
<span><span class="co">## colData names(80): barcode sample_name ... x_gc r_gc</span></span>
<span><span class="co">## reducedDimNames(6): PCA TSNE_perplexity50 ... TSNE_perplexity80</span></span>
<span><span class="co">##   UMAP_neighbors15</span></span>
<span><span class="co">## mainExpName: NULL</span></span>
<span><span class="co">## altExpNames(0):</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">dlpfc</span><span class="op">$</span><span class="va">row</span>, <span class="va">dlpfc</span><span class="op">$</span><span class="va">col</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pos</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      [,1] [,2]</span></span>
<span><span class="co">## [1,]   50  102</span></span>
<span><span class="co">## [2,]    3   43</span></span>
<span><span class="co">## [3,]   59   19</span></span>
<span><span class="co">## [4,]   14   94</span></span>
<span><span class="co">## [5,]   43    9</span></span>
<span><span class="co">## [6,]   47   13</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>; <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span></code></pre></div>
<p>In order to calculate the Adjoint matrix,we make BayesSpace metadata used in BayesSpace to get SCE.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">#  make BayesSpace metadata used in BayesSpace</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"gene_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"spot_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## Make array coordinates - filled rectangle</span></span>
<span><span class="va">cdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cdata</span><span class="op">$</span><span class="va">row</span> <span class="op">&lt;-</span> <span class="va">pos</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">cdata</span><span class="op">$</span><span class="va">col</span> <span class="op">&lt;-</span> <span class="va">pos</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">cdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">cdata</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">cdata</span><span class="op">$</span><span class="va">imagerow</span> <span class="op">&lt;-</span> <span class="va">cdata</span><span class="op">$</span><span class="va">row</span></span>
<span><span class="va">cdata</span><span class="op">$</span><span class="va">imagecol</span> <span class="op">&lt;-</span> <span class="va">cdata</span><span class="op">$</span><span class="va">col</span> </span>
<span>  <span class="co">## Make SCE</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/SingleCellExperiment.html" class="external-link">SingleCellExperiment</a></span><span class="op">(</span>assays<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>logcounts<span class="op">=</span><span class="va">counts</span><span class="op">)</span>, colData<span class="op">=</span><span class="va">cdata</span><span class="op">)</span></span>
<span><span class="va">princ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/princomp.html" class="external-link">princomp</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">sce</span>, <span class="st">"PCA"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">princ</span><span class="op">$</span><span class="va">scores</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">]</span></span>
<span>  <span class="co"># hq &lt;- selectFacNumber(X)$q</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">dlpfc</span><span class="op">$</span><span class="va">layer_guess_reordered</span><span class="op">)</span></span>
<span><span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'Unknown'</span></span>
<span>  </span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then we read the cell-type-specific marker information and construct a cell type marker matrix.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/find.package.html" class="external-link">path.package</a></span><span class="op">(</span><span class="st">"SpatialAnno"</span><span class="op">)</span>,<span class="st">"/extdata/151507_DEGmarkerTop_5.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">markers</span></span></code></pre></div>
<pre><code><span><span class="co">## $Layer1</span></span>
<span><span class="co">## [1] "ENSG00000131095" "ENSG00000170323" "ENSG00000182600" "ENSG00000171885"</span></span>
<span><span class="co">## [5] "ENSG00000125144"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $Layer2</span></span>
<span><span class="co">## [1] "ENSG00000115756" "ENSG00000171617" "ENSG00000125869" "ENSG00000135919"</span></span>
<span><span class="co">## [5] "ENSG00000136099"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $Layer3</span></span>
<span><span class="co">## [1] "ENSG00000164326" "ENSG00000171617" "ENSG00000135426" "ENSG00000171476"</span></span>
<span><span class="co">## [5] "ENSG00000187664"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $Layer4</span></span>
<span><span class="co">## [1] "ENSG00000100285" "ENSG00000104722" "ENSG00000277586" "ENSG00000105711"</span></span>
<span><span class="co">## [5] "ENSG00000139190"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $Layer5</span></span>
<span><span class="co">## [1] "ENSG00000183036" "ENSG00000145349" "ENSG00000074706" "ENSG00000034510"</span></span>
<span><span class="co">## [5] "ENSG00000244734"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $Layer6</span></span>
<span><span class="co">## [1] "ENSG00000128422" "ENSG00000165023" "ENSG00000142634" "ENSG00000171246"</span></span>
<span><span class="co">## [5] "ENSG00000136535"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $WM</span></span>
<span><span class="co">## [1] "ENSG00000123560" "ENSG00000197971" "ENSG00000168314" "ENSG00000173786"</span></span>
<span><span class="co">## [5] "ENSG00000170421"</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="run-spatialanno-on-dataset-brain">Run SpatialAnno on dataset brain<a class="anchor" aria-label="anchor" href="#run-spatialanno-on-dataset-brain"></a>
</h3>
<p>Then we find the neighborhoods using the function <code>find_neighbors2</code> implemented in our package <code>SpatialAnno</code>. After obtaining the sparse neighborhoods matrix <code>Adj_sp</code>, we can run SpatialAnno with normalized gene expression matrix <code>X</code>, sparse neighborhoods matrix <code>Adj_sp</code>, and a list of markers <code>marker</code>. Note that we choose the initial value from annotation methods <code>SCINA</code> due to the large number of non-markers.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org/" class="external-link">Matrix</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SpatialAnno</span><span class="op">)</span></span>
<span><span class="va">Adj_sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_neighbors2.html">find_neighbors2</a></span><span class="op">(</span><span class="va">sce</span>, platform<span class="op">=</span><span class="st">"Visium"</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SpatialAnno.html">SpatialAnno</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, Adj_sp <span class="op">=</span> <span class="va">Adj_sp</span>, marker <span class="op">=</span> <span class="va">markers</span>, initial <span class="op">=</span> <span class="st">"SCINA"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "ENSG00000125144" "ENSG00000131095" "ENSG00000170323" "ENSG00000171885"</span></span>
<span><span class="co">## [5] "ENSG00000182600"</span></span>
<span><span class="co">## [1] "ENSG00000115756" "ENSG00000125869" "ENSG00000135919" "ENSG00000136099"</span></span>
<span><span class="co">## [5] "ENSG00000171617"</span></span>
<span><span class="co">## [1] "ENSG00000135426" "ENSG00000164326" "ENSG00000171476" "ENSG00000171617"</span></span>
<span><span class="co">## [5] "ENSG00000187664"</span></span>
<span><span class="co">## [1] "ENSG00000100285" "ENSG00000104722" "ENSG00000105711" "ENSG00000139190"</span></span>
<span><span class="co">## [5] "ENSG00000277586"</span></span>
<span><span class="co">## [1] "ENSG00000034510" "ENSG00000074706" "ENSG00000145349" "ENSG00000183036"</span></span>
<span><span class="co">## [5] "ENSG00000244734"</span></span>
<span><span class="co">## [1] "ENSG00000128422" "ENSG00000136535" "ENSG00000142634" "ENSG00000165023"</span></span>
<span><span class="co">## [5] "ENSG00000171246"</span></span>
<span><span class="co">## [1] "ENSG00000123560" "ENSG00000168314" "ENSG00000170421" "ENSG00000173786"</span></span>
<span><span class="co">## [5] "ENSG00000197971"</span></span>
<span><span class="co">## iter = 2, loglik= -8324631.992248, dloglik=0.996124 </span></span>
<span><span class="co">## iter = 3, loglik= -5028607.920000, dloglik=0.395936 </span></span>
<span><span class="co">## iter = 4, loglik= -5025295.344448, dloglik=0.000659 </span></span>
<span><span class="co">## iter = 5, loglik= -5023953.746863, dloglik=0.000267 </span></span>
<span><span class="co">## iter = 6, loglik= -5023367.838578, dloglik=0.000117 </span></span>
<span><span class="co">## iter = 7, loglik= -5023036.341692, dloglik=0.000066 </span></span>
<span><span class="co">## iter = 8, loglik= -5022746.346818, dloglik=0.000058 </span></span>
<span><span class="co">## iter = 9, loglik= -5022500.196269, dloglik=0.000049 </span></span>
<span><span class="co">## iter = 10, loglik= -5022330.019250, dloglik=0.000034 </span></span>
<span><span class="co">## iter = 11, loglik= -5022219.583328, dloglik=0.000022 </span></span>
<span><span class="co">## iter = 12, loglik= -5022124.604322, dloglik=0.000019 </span></span>
<span><span class="co">## iter = 13, loglik= -5022017.020937, dloglik=0.000021 </span></span>
<span><span class="co">## iter = 14, loglik= -5021953.623224, dloglik=0.000013 </span></span>
<span><span class="co">## iter = 15, loglik= -5021908.650918, dloglik=0.000009 </span></span>
<span><span class="co">## iter = 16, loglik= -5021871.143358, dloglik=0.000007 </span></span>
<span><span class="co">## iter = 17, loglik= -5021839.729879, dloglik=0.000006 </span></span>
<span><span class="co">## iter = 18, loglik= -5021811.472676, dloglik=0.000006 </span></span>
<span><span class="co">## iter = 19, loglik= -5021783.327976, dloglik=0.000006 </span></span>
<span><span class="co">## iter = 20, loglik= -5021754.712541, dloglik=0.000006 </span></span>
<span><span class="co">## iter = 21, loglik= -5021729.303092, dloglik=0.000005 </span></span>
<span><span class="co">## iter = 22, loglik= -5021706.025741, dloglik=0.000005 </span></span>
<span><span class="co">## iter = 23, loglik= -5021673.748855, dloglik=0.000006 </span></span>
<span><span class="co">## iter = 24, loglik= -5021649.806830, dloglik=0.000005 </span></span>
<span><span class="co">## iter = 25, loglik= -5021626.452170, dloglik=0.000005 </span></span>
<span><span class="co">## iter = 26, loglik= -5021604.214380, dloglik=0.000004 </span></span>
<span><span class="co">## iter = 27, loglik= -5021582.536544, dloglik=0.000004 </span></span>
<span><span class="co">## iter = 28, loglik= -5021561.283712, dloglik=0.000004 </span></span>
<span><span class="co">## iter = 29, loglik= -5021540.299631, dloglik=0.000004 </span></span>
<span><span class="co">## iter = 30, loglik= -5021521.300188, dloglik=0.000004 </span></span>
<span><span class="co">## iter = 31, loglik= -5021501.666678, dloglik=0.000004 </span></span>
<span><span class="co">## iter = 32, loglik= -5021482.128862, dloglik=0.000004 </span></span>
<span><span class="co">## iter = 33, loglik= -5021462.159845, dloglik=0.000004 </span></span>
<span><span class="co">## iter = 34, loglik= -5021442.664011, dloglik=0.000004 </span></span>
<span><span class="co">## iter = 35, loglik= -5021415.610150, dloglik=0.000005 </span></span>
<span><span class="co">## iter = 36, loglik= -5021393.304977, dloglik=0.000004 </span></span>
<span><span class="co">## iter = 37, loglik= -5021364.743739, dloglik=0.000006 </span></span>
<span><span class="co">## iter = 38, loglik= -5021325.323470, dloglik=0.000008 </span></span>
<span><span class="co">## iter = 39, loglik= -5021301.976871, dloglik=0.000005 </span></span>
<span><span class="co">## iter = 40, loglik= -5021288.771651, dloglik=0.000003 </span></span>
<span><span class="co">## iter = 41, loglik= -5021275.427749, dloglik=0.000003 </span></span>
<span><span class="co">## iter = 42, loglik= -5021261.485971, dloglik=0.000003 </span></span>
<span><span class="co">## iter = 43, loglik= -5021249.825554, dloglik=0.000002 </span></span>
<span><span class="co">## iter = 44, loglik= -5021232.871448, dloglik=0.000003 </span></span>
<span><span class="co">## iter = 45, loglik= -5021223.534758, dloglik=0.000002 </span></span>
<span><span class="co">## iter = 46, loglik= -5021214.641819, dloglik=0.000002 </span></span>
<span><span class="co">## iter = 47, loglik= -5021209.622892, dloglik=0.000001</span></span></code></pre>
<p>We demonstrate the output of SpatialAnno, which is a list contains many items. We will briefly explain them one by one in the following part.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 13</span></span>
<span><span class="co">##  $ R      : num [1:3639, 1:8] 4.90e-10 1.00 7.11e-45 3.83e-09 4.39e-17 ...</span></span>
<span><span class="co">##  $ xi     : num 2.5</span></span>
<span><span class="co">##  $ type   : int [1:3639, 1] 3 1 7 3 6 7 7 3 2 8 ...</span></span>
<span><span class="co">##  $ alpha_m: num [1:34, 1] 0.284 1.541 0.158 0.492 0.351 ...</span></span>
<span><span class="co">##  $ bet_m  : num [1:34, 1:8] 0.459 0.625 0.131 0.346 0.153 ...</span></span>
<span><span class="co">##  $ mu_m   : num [1:34, 1:8] 0.743 2.166 0.289 0.838 0.505 ...</span></span>
<span><span class="co">##  $ sigma_m: num [1:34, 1] 0.286 1.721 0.181 0.471 0.306 ...</span></span>
<span><span class="co">##  $ Ez_u   : num [1:3639, 1:15] 26.9 19.2 26 27.4 24.1 ...</span></span>
<span><span class="co">##  $ Mu_u   : num [1:8, 1:15] 21.7 25.3 25.9 26.4 26.6 ...</span></span>
<span><span class="co">##  $ Sgm_u  : num [1:15, 1:15] 3.1267 0.6233 0.0138 0.5644 -0.0842 ...</span></span>
<span><span class="co">##  $ W_u    : num [1:1966, 1:15] -4.69e-03 1.72e-05 1.38e-02 1.22e-03 8.93e-02 ...</span></span>
<span><span class="co">##  $ Lam_u  : num [1:1966, 1] 0.222 0.172 0.377 0.397 0.509 ...</span></span>
<span><span class="co">##  $ loglik : num [1:46] -2.15e+09 -8.32e+06 -5.03e+06 -5.03e+06 -5.02e+06 ...</span></span></code></pre>
<ul>
<li>‘R’ the estimator of probability that each spot was assigned to these seven cell types or “Unknown”. The order of the cell types is the same as that of cell types in gene marker matrix.</li>
<li>‘xi’ the estimator of smooth parameter.</li>
<li>‘type’ the predicated cell types for each spot.</li>
<li>‘alpha_m’ the estimator of base expression level.</li>
<li>‘bet_m’ the estimator of extra expression level.</li>
<li>‘mu_m’ the mean of cell types in marker group.</li>
<li>‘sigma_m’ the covariance matrix of cell types in marker group.</li>
<li>‘Ez_u’ the low-dimensional embedding.</li>
<li>‘Mu_u’ the mean of cell types in non-marker group.</li>
<li>‘Sgm_u’ the covariance matrix of cell types in non-marker group.</li>
<li>‘W_u’ the estimator of factor loading matrix.</li>
<li>‘Lam_u’ the variance of error in non-marker group.</li>
<li>‘loglik’ the vector of log-likelihood of <code>SpatialAnno</code>.</li>
</ul>
</div>
<div class="section level3">
<h3 id="plot-the-annotation-results">plot the annotation results<a class="anchor" aria-label="anchor" href="#plot-the-annotation-results"></a>
</h3>
<p>The predictions can be obtained in the following way. Then we can plot the annotation results of SpatialAnno on the spatial positions using R package <code>ggplot2</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rho</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marker_list_to_mat.html">marker_list_to_mat</a></span><span class="op">(</span><span class="va">markers</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">prediction</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rho</span><span class="op">)</span><span class="op">[</span><span class="va">fit</span><span class="op">$</span><span class="va">type</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "Layer3" "Layer1" "WM"     "Layer3" "Layer6" "WM"     "WM"     "Layer3"</span></span>
<span><span class="co">##  [9] "Layer2" "other"  "WM"     "Layer4" "Layer5" "Layer3" "Layer5" "Layer4"</span></span>
<span><span class="co">## [17] "Layer6" "Layer5" "Layer2" "Layer6"</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org" class="external-link">scales</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span></span>
<span><span class="va">colfunc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"white"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit_type</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rho</span><span class="op">)</span><span class="op">[</span><span class="va">fit</span><span class="op">$</span><span class="va">type</span><span class="op">]</span></span>
<span><span class="va">dat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">-</span><span class="va">pos</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pos</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">fit_type</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"imagerow"</span>, <span class="st">"imagecol"</span>, <span class="st">"Cell type"</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">imagerow</span>, y<span class="op">=</span><span class="va">imagecol</span>, color<span class="op">=</span><span class="va">`Cell type`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.text.y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.title.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.title.y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          panel.border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.ticks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#FFD700"</span>, <span class="fu">colfunc</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">[</span><span class="op">(</span><span class="fl">7</span><span class="op">)</span><span class="op">*</span><span class="fl">5</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fl">9</span>, <span class="st">"Greens"</span><span class="op">)</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/pkg/scales/man/hue_pal.html" class="external-link">hue_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fl">9</span>, <span class="st">"Blues"</span><span class="op">)</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span>,<span class="st">"#de8e4a"</span>,<span class="st">"#574b8b"</span><span class="op">)</span>, <span class="st">"#808080"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p1</span></span></code></pre></div>
<p><img src="brain_files/figure-html/unnamed-chunk-6-1.png" width="480"></p>
</div>
<div class="section level3">
<h3 id="calculate-kappa-mf1-and-acc">calculate Kappa, mF1, and acc<a class="anchor" aria-label="anchor" href="#calculate-kappa-mf1-and-acc"></a>
</h3>
<p>After obtaining the predictions, we can calculate Kappa, mF1 (mean F1), and acc to evalute the performance of annotation results by <code>SpatialAnno</code>. The function <code>cohen.kappa</code> to calculate Kappa is implemented in the package psych. The function <code>evaluate</code> to calculate mF1 is implemented in our package <code>SpatialAnno</code>. The Kappa is</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://personality-project.org/r/psych/" class="external-link">psych</a></span><span class="op">)</span></span>
<span><span class="va">idx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">y</span><span class="op">!=</span><span class="st">"Unknown"</span> <span class="op">&amp;</span> <span class="va">prediction</span><span class="op">!=</span><span class="st">"Unknown"</span><span class="op">)</span></span>
<span><span class="va">Kappa</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/psych/man/kappa.html" class="external-link">cohen.kappa</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>,<span class="va">prediction</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">kappa</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">Kappa</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.6366594</span></span></code></pre>
<p>The mF1 is</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mF1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="../reference/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>, <span class="va">prediction</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">F1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">mF1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.7034749</span></span></code></pre>
<p>The acc is</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">acc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span> <span class="op">==</span> <span class="va">prediction</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">acc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.6870673</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="extract-the-embeddings">extract the embeddings<a class="anchor" aria-label="anchor" href="#extract-the-embeddings"></a>
</h3>
<p>Then we extract the embeddings from the output of <code>SpatialAnno</code>, and plot the tSNE and calculate ARI with the function <code>adjustedRandIndex</code> implemented in the R package <code>mclust</code></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://bioconductor.org/packages/scater/" class="external-link">scater</a></span><span class="op">)</span></span>
<span><span class="va">embedding</span> <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">Ez_u</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          [,1]      [,2]     [,3]     [,4]       [,5]     [,6]      [,7]</span></span>
<span><span class="co">## [1,] 26.89808 15.736737 2.661745 6.161762  1.2970847 1.473094 0.9213079</span></span>
<span><span class="co">## [2,] 19.15042 10.925543 3.870784 7.168316 -0.9168423 3.729039 2.6188424</span></span>
<span><span class="co">## [3,] 26.04855  1.063387 5.014252 7.977632  3.7255440 1.944812 6.8664005</span></span>
<span><span class="co">## [4,] 27.39303 12.239549 2.900000 8.004302  1.6045045 1.892769 0.2855525</span></span>
<span><span class="co">## [5,] 24.08825 13.993763 4.408703 5.202428  1.1634168 2.081948 2.1209084</span></span>
<span><span class="co">## [6,] 25.68315 10.662820 5.759093 5.431061  3.4447588 1.171190 2.3214402</span></span>
<span><span class="co">##            [,8]       [,9]      [,10]      [,11]     [,12]     [,13]      [,14]</span></span>
<span><span class="co">## [1,]  0.5954158  1.5147271  0.3085456  0.1840706 -6.376630  3.451434 -0.3134824</span></span>
<span><span class="co">## [2,]  2.5306243  2.0415729 -1.0347716 -0.9747615 -2.671954  4.062614  0.1099388</span></span>
<span><span class="co">## [3,] -0.2450746 -0.5606354  6.9221739  1.3260047  1.598664 17.333739 -2.3089589</span></span>
<span><span class="co">## [4,]  0.2080496  0.7064720  1.6166107  0.8240713 -5.807464  3.142940 -0.6752540</span></span>
<span><span class="co">## [5,] -0.6853934  0.1440243  0.6793812  2.3812871 -1.958452  3.686392 -3.0932489</span></span>
<span><span class="co">## [6,] -0.7569758  0.2720900  2.0593644  1.2993630 -1.335975  6.763731 -2.1250908</span></span>
<span><span class="co">##          [,15]</span></span>
<span><span class="co">## [1,] -23.05334</span></span>
<span><span class="co">## [2,] -21.40557</span></span>
<span><span class="co">## [3,] -20.68132</span></span>
<span><span class="co">## [4,] -25.92797</span></span>
<span><span class="co">## [5,] -22.37180</span></span>
<span><span class="co">## [6,] -22.63432</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tsne</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/runTSNE.html" class="external-link">calculateTSNE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The tSNE plot is</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">tsne</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">cluster</span> <span class="op">=</span> <span class="va">prediction</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X</span>, y<span class="op">=</span><span class="va">Y</span>, color<span class="op">=</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="../reference/theme_Publication.html">theme_Publication</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>          legend.text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">14</span><span class="op">)</span>,</span>
<span>          axis.text.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.text.y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.title.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.title.y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          panel.border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.ticks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#FFD700"</span>, <span class="fu">colfunc</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">[</span><span class="op">(</span><span class="fl">7</span><span class="op">)</span><span class="op">*</span><span class="fl">5</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fl">9</span>, <span class="st">"Greens"</span><span class="op">)</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/pkg/scales/man/hue_pal.html" class="external-link">hue_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fl">9</span>, <span class="st">"Blues"</span><span class="op">)</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span>,<span class="st">"#de8e4a"</span>,<span class="st">"#574b8b"</span><span class="op">)</span>, <span class="st">"#808080"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p1</span></span></code></pre></div>
<p><img src="brain_files/figure-html/unnamed-chunk-11-1.png" width="384"></p>
<p>Then we perform the clustering analysis with GMM (other clustering methods are also can be used) on embeddings and calculate ARI. The ARI is</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit2</span> <span class="op">=</span> <span class="fu"><a href="https://mclust-org.github.io/mclust/reference/Mclust.html" class="external-link">Mclust</a></span><span class="op">(</span><span class="va">embedding</span>, G <span class="op">=</span> <span class="fl">5</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">ARI</span> <span class="op">=</span> <span class="fu"><a href="https://mclust-org.github.io/mclust/reference/adjustedRandIndex.html" class="external-link">adjustedRandIndex</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">fit2</span><span class="op">$</span><span class="va">classification</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ARI</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.5250233</span></span></code></pre>
<p>We can also plot RGB plot with the function <code>plot_RGB</code> implemented in <code>PRECAST</code>. The RGB plot is demonstrated as follows</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/feiyoung/PRECAST" class="external-link">PRECAST</a></span><span class="op">)</span></span>
<span><span class="va">tsne3dim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/runTSNE.html" class="external-link">calculateTSNE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span>, ncomponents <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">pos2</span> <span class="op">=</span> <span class="va">pos</span></span>
<span><span class="va">pos2</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="va">pos</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">pList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PRECAST/man/plot_RGB.html" class="external-link">plot_RGB</a></span><span class="op">(</span><span class="va">pos2</span>, <span class="va">tsne3dim</span>, pointsize <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">pList</span></span></code></pre></div>
<p><img src="brain_files/figure-html/unnamed-chunk-13-1.png" width="288"></p>
</div>
<div class="section level3">
<h3 id="gene-expression-plot-of-markers">gene expression plot of markers<a class="anchor" aria-label="anchor" href="#gene-expression-plot-of-markers"></a>
</h3>
<p>We can also plot the expression levels of corresponding cell type-specific marker genes.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">genes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ENSG00000171885"</span>,<span class="st">"ENSG00000115756"</span>,<span class="st">"ENSG00000164326"</span>,<span class="st">"ENSG00000100285"</span>,<span class="st">"ENSG00000183036"</span>,<span class="st">"ENSG00000128422"</span>,<span class="st">"ENSG00000168314"</span><span class="op">)</span></span>
<span><span class="va">genes1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AQP4"</span>,<span class="st">"HPCAL1"</span>,<span class="st">"CARTPT"</span>,<span class="st">"NEFH"</span>,<span class="st">"PCP4"</span>,<span class="st">"KRT17"</span>,<span class="st">"MOBP"</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">idx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">genes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">dat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">pos</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">pos</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">X</span><span class="op">[</span>,<span class="va">idx</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"imagerow"</span>, <span class="st">"imagecol"</span>, <span class="st">"cluster"</span><span class="op">)</span></span>
<span>      <span class="va">dat</span><span class="op">$</span><span class="va">gene</span> <span class="op">=</span> <span class="va">genes1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">else</span><span class="op">{</span></span>
<span>      <span class="va">idx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">genes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">dat2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">pos</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">pos</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">X</span><span class="op">[</span>,<span class="va">idx</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat2</span><span class="op">)</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"imagerow"</span>, <span class="st">"imagecol"</span>, <span class="st">"cluster"</span><span class="op">)</span></span>
<span>      <span class="va">dat2</span><span class="op">$</span><span class="va">gene</span> <span class="op">=</span> <span class="va">genes1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>      <span class="va">dat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">dat2</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#0571B0"</span>,  <span class="st">"#CA0020"</span><span class="op">)</span></span>
<span><span class="va">quant</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">gene</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">gene</span>, levels <span class="op">=</span> <span class="va">genes1</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">markers</span> <span class="op">=</span> <span class="st">"markers"</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="op">-</span><span class="va">imagerow</span>, y<span class="op">=</span><span class="va">imagecol</span>, color<span class="op">=</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">markers</span><span class="op">~</span><span class="va">dat</span><span class="op">$</span><span class="va">gene</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/scale_gradient.html" class="external-link">scale_colour_gradient2</a></span><span class="op">(</span></span>
<span>      low <span class="op">=</span> <span class="st">"#0571B0"</span>,</span>
<span>      mid <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>      high <span class="op">=</span> <span class="st">"#CA0020"</span>, midpoint <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="../reference/theme_Publication.html">theme_Publication</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.title.x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.text.x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.ticks.x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.title.y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.text.y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.ticks.y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          strip.text.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p2</span></span></code></pre></div>
<p><img src="brain_files/figure-html/unnamed-chunk-14-1.png" width="1920"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Yi Yang, Xingjie Shi.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
